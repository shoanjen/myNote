# SDK代码理解 

1. 加密机默认两个端口：
    - 8013：管理登录工具
    - 8018：跑业务

2. 使用密钥的两种方式：
    - 密钥索引：存储在加密机中（int）
    - 密钥密文：密码机产生的密钥密文（String）

3. Forms
   	类型处理工具类（数据类型转换、byte、integer等等）

4. hsmGeneralFinance
   	常用算法接口

5. HardLib extends BaseHardlib
   	加密机信息类

6. Communication
   	加密机实例信息类

7. Configuration
   	加密机配置类，配置文件

8. Logger
   	日志类

9. 获取加密机的两种方式

   - 拼接[属性名];属性项

     ![image-20230223162427795](https://cdn.staticaly.com/gh/shoanjen/images-note@main/blog/image-20230223162427795.png)

   - 配置文件方式：类似于SpringBoot中.yml配置文件

# 常见的加密算法（国密算法与国际算法）

|    算法类型    | 国密算法 | 国际算法 |
| :------------: | :------: | :------: |
|  对称加密算法  |   SM1    |   AES    |
|                |   SM4    | DES/3DES |
| 非对称加密算法 |   SM2    |   RSA    |
|    摘要算法    |   SM3    |  SHA256  |

# 密码工具箱

1. 对称密码
2. 公钥密码
3. 单向散列函数/消息摘要函数/哈希函数/杂凑函数
   - 解释：输入消息（原像）的散列值（消息摘要/指纹）。类似于hashcode值。
   - 作用：确保消息的完整新（一致性），没有被篡改。
   - 性质：固长性；快速性；抗碰撞性；单向性。
4. 消息认证码（MAC）
   - 解释：一种和密钥相关联的散列值。
   - 作用：确保消息的完整性（一致性)，没有被篡改。
   - 注意：必须持有共享密钥。
   - 补充：HMAC一种基于单向散列函数生成的消息认证码。
5. 数字签名
   - 解释：发送者和接收者使用不同的密钥，发送者生成签名消息，接收者验证签名消息。
   - 作用：确保消息的真实性（防伪装）。
   - 注意：持有不同密钥。
   - 方法：直接对消息签名；对消息的散列值签名。通过<a href="#RSA签名生成和验证">RSA生成签名。</a>
6. 伪随机数生成器

# 对称密码算法

> 发送者和接收者在加密解密时，采用相同的密钥。 

![](https://cdn.staticaly.com/gh/shoanjen/images-note@main/blog/image-20230223163211342.png)

## 分组密码模式

> 每次处理一块特定长度的密码算法。一块称为**分组**；特定长度为**分组长度**

1. ECB：电子密码本模式。明文分组加密后的结果就是密文分组。

      - 特点：明文分组与密文分组相对应，如果有重复的就会推算出重复的组合。
      - 补充：当最后一个明文分组的内容长度小于分组长度时，需要进行填充。

   ![](https://cdn.staticaly.com/gh/shoanjen/images-note@main/blog/image-20230223163944353.png)

2. CBC：密文分组链接模式。将前一个密文分组与当前明文分组的内容混合（XOR运算），然后进行加密。

   - 特点：密文分组损坏或者比特位缺失，会影响密文解密。
   - 补充：因为第一个密文分组不存在，用长度为1个分组的比特序列来代替，称为初始向量IV。

   ![](https://cdn.staticaly.com/gh/shoanjen/images-note@main/blog/image-20230223164124248.png)

3. CFB：密文反馈模式。前一个密文分组返回到加密算法输入端。将前一个密文分组进行加密，然后与当前明文分   组进行XOR运算。
    - 补充：因为第一个密文分组不存在，用长度为1个分组的比特序列来代替，称为初始向量IV。

   ![](https://cdn.staticaly.com/gh/shoanjen/images-note@main/blog/image-20230223164212174.png)

4. OFB：输出反馈模式。加密算法的输出返回到加密算法的输入。
   	- 补充：因为第一个密文分组不存在，用长度为1个分组的比特序列来代替，称为初始向量IV。

   ![](https://cdn.staticaly.com/gh/shoanjen/images-note@main/blog/image-20230223164401355.png)

5. CTR模式：一种通过将逐次累加的计数器进行加密来生成密钥流的流密码。

   - 计数器生成方法：每次加密时生成不同的nonce作为初始值，长度>128bit时，分组序号发生变化。

   ![image-20230224153133118](https://cdn.staticaly.com/gh/shoanjen/images-note@main/blog/image-20230224153133118.png)

## 对称密钥算法标识

> 密钥首字母代表算法类型，其余为密钥长度。

       1. Z-单DES，8字节
       2. R-SM4，16字节

## 常见的分组密码算法的分组长度及密钥长度

| 密码算法 |   分组长度    |    密钥长度     |
| :------: | :-----------: | :-------------: |
|   DES    |  64bit/8字节  | 56bit有效长度+8 |
|   2DES   | 128bit/16字节 |      64*2       |
|   3DES   | 192bit/24字节 |      64*3       |
|   AES    | 128bit/16字节 | 128/192/256bit  |
|   SM1    | 128bit/16字节 |  128bit/16字节  |
|   SM4    | 128bit/16字节 |  128bit/16字节  |
|   SM7    | 128bit/16字节 |  128bit/16字节  |

## 分组加密填充模式

> 填充模式随意搭配，满足分组长度（块长度）的整数倍不填充。

```
1. PSCS5&PKCS7-每个填充字节的值是填充字节的个数。
   	例：|AA AA AA AA AA|AA AA 03 03 03|	

2. ANSI X.923-最右端添加填充的字节数即0xpad，前方补0x00
   例：|AA AA AA AA AA|AA AA 00 00 03|，若原数据块为AA AA 00 00 03，则填充00 00 00 00 05。
   注：最右端字节填充范围0x00~0x10。

3. NOPadding模式-密码机不处理数据的PADDING，外部应用系统将数据填充到分组长度的整数倍。

4. PBOC 2.0规范-先填充一个0x80,后边至少填充满足长度的0x00
   例：|AA AA AA AA AA|AA AA 80 00 00|
   注：最后一个字节为0x80,不建议使用此模式。
```

# 非对称密码算法/公钥密码算法

> 接收者和发送者采用不同的密钥进行加密和解密。  

![](https://cdn.staticaly.com/gh/shoanjen/images-note@main/blog/image-20230224093800848.png)

## RSA算法

### RSA加密和解密

![](https://cdn.staticaly.com/gh/shoanjen/images-note@main/blog/image-20230224094542457.png)

### RSA签名生成和验证

![](https://cdn.staticaly.com/gh/shoanjen/images-note@main/blog/image-20230224094730340.png)

# 接口调用

## 报文长度&类型缩写

> 接口入参参数的类型、长度缩写约定。

	n-可变域名长度
	m-报文头长度
	A-字母数字字符，包括任何ASCII码
	H-16进制字符，‘0’-‘9’和‘A’-‘F’
	N-十进制数字字符，‘0’-‘9’
	B-二进制字符（字节），X00-XFF
	K-密钥存储标识，是否存储到密码机，如果为是，后续则为4N的数字字符。

## 密钥分散级数&密钥分散因子

> 接口中disperSeries&disperFactor参数 

`disperFactor取值不限制内容，满足相应分散级数的长度并且满足数据类型即可。`

## 填充模式

> 接口中padFlag参数

`无特定输入要求，但要注意每种填充模式的特点`

## 问题错误

1. 生成随机数：	
   源密钥奇校验错误--密钥问题。

2. 计算mac时：
   无效的输入数据 (无效的格式，无效的字符，或输入的数据长度不够等)-检查源密钥类型、源密钥与初始向量字节长度。

3. Data verification failed:

   查看源码中“return Faild.<%s>”代码。

4. 对称加密时：
   无效的输入数据 (无效的格式，无效的字符，或输入的数据长度不够等)-检查需要加密的数据的类型、长度。

# 知识补充

1. 1字节等于8位二进制数；1字节等于2个16进制数；1个16进制数为4位二进制数。
2. XOR运算：两者相同则为0，否则为1。
3. 长连接：建立连接使用完后不会主动关闭；短连接：只进行一次读写操作便关闭。
4. 保活：用于服务端检测客户端是否可达，不可达则关闭连接（发送数据包，心跳检测机制）。
5. TCP命令报文格式与响应报文格式，类似于http请求报文内容与响应内容。
6. Integer.parseInt与Integer.valueOf都为String转为int类型。前者返回值为int，后者返回值为Integer。
7. IP：网际协议，位于网络层。IP间的通信依赖于MAC地址（由ARP协议得到）。
8. TCP：传输控制协议，位于传输层。提供可靠性的数据传输。（字节流）。
9. ![](https://cdn.staticaly.com/gh/shoanjen/images-note@main/blog/image-20230223172338075.png)
10. 客户端与服务端数据交互的全过程![](https://cdn.staticaly.com/gh/shoanjen/images-note@main/blog/image-20230223172418831.png)

# 学习中个人理解

1. 接口文档中的接口入参与出参，分别对应命令报文格式与响应报文格式的数据元素。  
2. TCP命令报文格式与应答报文格式类似于HTTP报文。





   





